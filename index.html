<html ng-app="goast">
  <head>
    <meta name="viewport" content="width=device-width,  initial-scale=1">
    <link rel="stylesheet" href="pure-min.css">
    <link rel="stylesheet" href="https://purecss.io/combo/1.16.1?/css/main-grid.css&/css/main.css&/css/home.css&/css/rainbow/baby-blue.css">
    <link rel="stylesheet" href="angular-ui-tree.min.css">
    <link rel="stylesheet" href="goast.css">
    <link href='https://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.18/angular.min.js"></script>
    <script src="angular-ui-tree.min.js"></script>
    <script src="goast.js"></script>
    <script src="wasm_exec.js"></script>
    <script>
      // 确保 window.global 存在
      if (typeof window.global === 'undefined') {
        window.global = window;
      }
      
      if (!WebAssembly.instantiateStreaming) {
        // polyfill
        WebAssembly.instantiateStreaming = async (resp, importObject) => {
          const source = await (await resp).arrayBuffer();
          return await WebAssembly.instantiate(source, importObject);
        };
      }
      
      // 使用全局变量，确保其他脚本可以访问
      window.wasmBytes = null;
      window.wasmReady = false;
      
      // 初始化 WASM 模块（只加载，不编译）
      fetch("lib.wasm").then(response => response.arrayBuffer()).then(bytes => {
        window.wasmBytes = bytes;
        window.wasmReady = true;
        console.log("WASM bytes loaded successfully, size:", bytes.byteLength);
      }).catch(err => {
        console.error("Failed to load WASM module:", err);
        window.wasmReady = false;
      });
      
      // 确保 output 在全局作用域
      window.output = window.output || "";
      
      // 将 run 函数也放到全局作用域
      window.run = async function() {
        if (!window.wasmReady || !window.wasmBytes) {
          console.error("WASM module not ready yet");
          throw new Error("WASM module not ready");
        }
        
        try {
          // 每次调用都创建新的 Go 实例
          const go = new Go();
          
          // 检查 importObject 是否存在
          if (!go.importObject) {
            console.error("Go importObject is not available");
            throw new Error("Go importObject is not available");
          }
          
          console.log("Instantiating WASM with importObject:", go.importObject);
          
          // 使用 ArrayBuffer 直接实例化 WASM 模块
          // WebAssembly.instantiate(bufferSource, importObject) 返回 { module, instance }
          console.log("Instantiating WASM module from bytes...");
          console.log("WASM bytes size:", window.wasmBytes.byteLength);
          console.log("Import object:", go.importObject);
          
          const result = await WebAssembly.instantiate(window.wasmBytes, go.importObject);
          
          console.log("WASM instantiated successfully");
          console.log("Full result:", result);
          console.log("Result type:", typeof result);
          console.log("Result keys:", result ? Object.keys(result) : "result is null/undefined");
          
          // 检查返回值结构
          if (!result) {
            throw new Error("WebAssembly.instantiate returned null or undefined");
          }
          
          // WebAssembly.instantiate 返回 { module, instance }
          const wasmInstance = result.instance;
          if (!wasmInstance) {
            console.error("Unexpected result structure:", result);
            throw new Error("Invalid WASM result structure. Expected {module, instance}, got: " + JSON.stringify(Object.keys(result || {})));
          }
          
          console.log("WASM instance:", wasmInstance);
          console.log("WASM exports:", wasmInstance.exports);
          console.log("WASM exports keys:", wasmInstance.exports ? Object.keys(wasmInstance.exports) : "no exports");
          
          // 检查实例是否有效
          if (!wasmInstance.exports) {
            throw new Error("Invalid WASM instance: missing exports");
          }
          
          // 运行 Go 程序（这会执行 main 函数）
          await go.run(wasmInstance);
          
          console.log("WASM execution completed, output:", window.output);
        } catch (err) {
          console.error("Error running WASM:", err);
          console.error("Error details:", err.message, err.stack);
          throw err;
        }
      }
    </script>

  </head>
  <body>
    <div id="main">
      <div class="hero">
        <div class="hero-titles">
          <h1 class="hero-site" style="font-size:400%">GoAst Viewer</h1>
          <h2 class="hefo-tagline">Golang AST visualizer.</h2>
        </div>
        <div class="hero-cta">
            <div class="is-code-full">
              <pre class="code code-wrap" data-language="html">
              <code class="rainbow">
              <a href="https://twitter.com/yuroyoro" target="_blank">@yuroyoro</a> | <a href="https://github.com/yuroyoro/goast-viewer" target="_blank"> https://github.com/yuroyoro/goast-viewer </a>
              </code></pre>
            </div>
        </div>
      </div>
      <div class="pure-g goast-layout" ng-controller="GoastController">
        <div class="source pure-u-1-2">
          <legend>Source</legend>
          <form class="pure-form pure-form-aligned">

              <div class="pure-control-group">
                  <input type="file" id="sourcefile" name="sourcefile" placeholder="souce file" ng-model="sourcefile" file-change>
                  <button type="submit" class="pure-button pure-button-primary" ng-click="parse()">Parse</button>
              </div>
              <div class="pure-control-group">
                  <textarea class="area" id="code" name="code"  ng-model="source"></textarea>
              </div>
          </form>
        </div>
        <div class="ast pure-u-1-2">
          <legend>AST Tree</legend>

          <button class="pure-button button-success btn-collapse-all" ng-click="collapseAll()">Collapse all</button>
          <button class="pure-button button-secondary btn-expand-all" ng-click="expandAll()">Expand all</button>

          <!-- Nested node template -->
          <script type="text/ng-template" id="nodes_renderer.html">
            <div class="tree-node tree-node-content" data-nodrag ng-click="toggle(this)">
              <a class="btn pure-button pure-button--success" data-nodrag ><span class="glyphicon" ng-class="{'glyphicon-chevron-right': collapsed, 'glyphicon-chevron-down': !collapsed}">
                {{ collapsedLabel(this) }}
              </span></a>
              {{node.label}}
            </div>
            <ol ui-tree-nodes="" ng-model="node.children" ng-class="{hidden: collapsed}">
              <li ng-repeat="node in node.children" ui-tree-node ng-include="'nodes_renderer.html'" collapsed="true" ng-mouseover="focus(this);$event.stopPropagation()">
              </li>
            </ol>
          </script>
          <div ui-tree id="tree-root">
            <ol ui-tree-nodes="" ng-model="asts">
              <li ng-repeat="node in asts" ui-tree-node ng-include="'nodes_renderer.html'" ng-mouseover="focus(this); $event.stopPropagation()"></li>
            </ol>
          </div>

          <legend>Dump</legend>
          <pre class="dump">{{ dump }} </pre>

        </div>
      </div>
   </div>
  </body>
</html>
