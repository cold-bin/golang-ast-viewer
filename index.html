<html ng-app="goast">
  <head>
    <meta name="viewport" content="width=device-width,  initial-scale=1">
    <link rel="stylesheet" href="pure-min.css">
    <link rel="stylesheet" href="https://purecss.io/combo/1.16.1?/css/main-grid.css&/css/main.css&/css/home.css&/css/rainbow/baby-blue.css">
    <link rel="stylesheet" href="angular-ui-tree.min.css">
    <link rel="stylesheet" href="goast.css">
    <link href='https://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.18/angular.min.js"></script>
    <script src="angular-ui-tree.min.js"></script>
    <script src="goast.js"></script>
    <script src="wasm_exec.js"></script>
    <script>
      // 确保 window.global 存在
      if (typeof window.global === 'undefined') {
        window.global = window;
      }
      
      if (!WebAssembly.instantiateStreaming) {
        // polyfill
        WebAssembly.instantiateStreaming = async (resp, importObject) => {
          const source = await (await resp).arrayBuffer();
          return await WebAssembly.instantiate(source, importObject);
        };
      }
      
      // 使用全局变量，确保其他脚本可以访问
      window.wasmBytes = null;
      window.wasmReady = false;
      
      // 初始化 WASM 模块（只加载，不编译）
      fetch("lib.wasm").then(response => response.arrayBuffer()).then(bytes => {
        window.wasmBytes = bytes;
        window.wasmReady = true;
      }).catch(err => {
        console.error("Failed to load WASM module:", err);
        window.wasmReady = false;
      });
      
      // 确保 output 在全局作用域
      window.output = window.output || "";

      // Start Go WASM runtime ONCE and keep it alive (no per-parse go.run restart).
      window.__goastWasm = window.__goastWasm || {
        startPromise: null
      };

      window.startWasm = async function() {
        if (window.__goastWasm.startPromise) return window.__goastWasm.startPromise;

        window.__goastWasm.startPromise = (async () => {
          if (!window.wasmReady || !window.wasmBytes) {
            throw new Error("WASM module not ready");
          }

          const go = new Go();
          if (!go.importObject) {
            throw new Error("Go importObject is not available");
          }

          const result = await WebAssembly.instantiate(window.wasmBytes, go.importObject);
          const wasmInstance = result && result.instance;
          if (!wasmInstance || !wasmInstance.exports) {
            throw new Error("Invalid WASM instance");
          }

          // go.run never resolves because Go program stays alive; don't await it.
          go.run(wasmInstance).catch(err => console.error("go.run failed:", err));

          // Wait until Go registers parseGoSource.
          const start = Date.now();
          while (typeof window.parseGoSource !== "function") {
            if (Date.now() - start > 5000) {
              throw new Error("WASM started but parseGoSource not available");
            }
            await new Promise(r => setTimeout(r, 10));
          }

          return true;
        })();

        return window.__goastWasm.startPromise;
      }
    </script>

  </head>
  <body>
    <div id="main">
      <div class="hero">
        <div class="hero-titles">
          <h1 class="hero-site" style="font-size:400%">GoAst Viewer</h1>
          <h2 class="hefo-tagline">Golang AST visualizer.</h2>
        </div>
        <div class="hero-cta">
            <div class="is-code-full">
              <pre class="code code-wrap" data-language="html">
              <code class="rainbow">
              <a href="https://github.com/cold-bin" target="_blank">@cold-bin</a> | <a href="https://github.com/cold-bin/goast-viewer/tree/feat/update_go_version" target="_blank"> https://github.com/cold-bin/goast-viewer/tree/feat/update_go_version </a>
              </code></pre>
            </div>
        </div>
      </div>
      <div class="pure-g goast-layout" ng-controller="GoastController">
        <div class="source pure-u-1-2">
          <legend>Source</legend>
          <form class="pure-form pure-form-aligned">

              <div class="pure-control-group">
                  <input type="file" id="sourcefile" name="sourcefile" placeholder="souce file" ng-model="sourcefile" file-change>
                  <button type="button" class="pure-button pure-button-primary" ng-click="parse()">Parse</button>
              </div>
              <div class="pure-control-group">
                  <textarea class="area" id="code" name="code"  ng-model="source"></textarea>
              </div>
          </form>
        </div>
        <div class="ast pure-u-1-2">
          <legend>AST Tree</legend>

          <button class="pure-button button-success btn-collapse-all" ng-click="collapseAll()">Collapse all</button>
          <button class="pure-button button-secondary btn-expand-all" ng-click="expandAll()">Expand all</button>

          <!-- Nested node template -->
          <script type="text/ng-template" id="nodes_renderer.html">
            <div class="tree-node tree-node-content" data-nodrag ng-click="toggle(this); focus(this); $event.stopPropagation()">
              <a class="btn pure-button pure-button--success" data-nodrag ><span class="glyphicon" ng-class="{'glyphicon-chevron-right': collapsed, 'glyphicon-chevron-down': !collapsed}">
                {{ collapsedLabel(this) }}
              </span></a>
              {{node.label}}
            </div>
            <ol ui-tree-nodes="" ng-if="!collapsed" ng-model="node.children">
              <li ng-repeat="node in node.children track by $index" ui-tree-node ng-include="'nodes_renderer.html'" collapsed="true">
              </li>
            </ol>
          </script>
          <div ui-tree id="tree-root">
            <ol ui-tree-nodes="" ng-model="asts">
              <li ng-repeat="node in asts track by $index" ui-tree-node ng-include="'nodes_renderer.html'"></li>
            </ol>
          </div>

          <legend>Dump</legend>
          <pre class="dump">{{ dump }} </pre>

        </div>
      </div>
   </div>
  </body>
</html>
